pipeline {
    agent any
    
    environment {
        // ConfiguraciÃ³n del proyecto
        BACKEND_PATH = '/opt/hero_budget/backend'
        BACKUP_PATH = '/opt/hero_budget/backups'
        SERVICE_NAME = 'herobudget'
        REPO_NAME = 'herobudget-backend'
        
        // Scripts de automatizaciÃ³n
        WEBHOOK_DEPLOY_SCRIPT = './scripts/webhook_deploy.sh'
        MANAGE_SERVICES_SCRIPT = './scripts/manage_services.sh'
        VERIFY_DEPLOYMENT_SCRIPT = './scripts/verify_deployment.sh'
        
        // ConfiguraciÃ³n de notificaciones
        SLACK_CHANNEL = '#herobudget-deployments'
        EMAIL_RECIPIENTS = 'admin@herobudget.com'
        
        // Variables de estado
        DEPLOYMENT_STATUS = 'UNKNOWN'
        BACKUP_FILE = ''
        BUILD_TIMESTAMP = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()
    }
    
    options {
        // Configurar timeouts y retenciones
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipDefaultCheckout(false)
        
        // Configurar triggers
        triggers {
            githubPush()
        }
    }
    
    stages {
        stage('ðŸ” Pre-Deploy Checks') {
            steps {
                script {
                    echo "ðŸš€ Iniciando pipeline CI/CD Hero Budget Backend"
                    echo "=================================================="
                    echo "Build: ${env.BUILD_NUMBER}"
                    echo "Branch: ${env.GIT_BRANCH}"
                    echo "Commit: ${env.GIT_COMMIT}"
                    echo "Timestamp: ${BUILD_TIMESTAMP}"
                    echo "=================================================="
                    
                    // Hacer ejecutables los scripts
                    sh '''
                        chmod +x scripts/*.sh 2>/dev/null || true
                        echo "âœ… Scripts marcados como ejecutables"
                    '''
                    
                    // Verificar informaciÃ³n del commit
                    sh '''
                        echo "ðŸ“‹ InformaciÃ³n del commit:"
                        git log --oneline -1
                        echo ""
                        echo "ðŸ“‚ Archivos modificados:"
                        git diff --name-only HEAD~1 HEAD || echo "Primer commit"
                    '''
                }
            }
        }
        
        stage('ðŸ”§ Code Quality & Tests') {
            parallel {
                stage('ðŸ§ª Run Tests') {
                    steps {
                        script {
                            echo "ðŸ§ª Ejecutando tests del proyecto..."
                            
                            sh '''
                                # Verificar si Go estÃ¡ disponible
                                if command -v go &> /dev/null; then
                                    echo "âœ… Go disponible: $(go version)"
                                    
                                    # Ejecutar tests si existen
                                    if find . -name "*_test.go" | grep -q .; then
                                        echo "ðŸ§ª Ejecutando tests Go..."
                                        go test ./... -v
                                    else
                                        echo "â„¹ï¸ No se encontraron tests Go"
                                    fi
                                    
                                    # Verificar sintaxis
                                    echo "ðŸ” Verificando sintaxis Go..."
                                    go vet ./...
                                else
                                    echo "âš ï¸ Go no disponible en Jenkins"
                                fi
                            '''
                        }
                    }
                }
                
                stage('ðŸ”’ Security Scan') {
                    steps {
                        script {
                            echo "ðŸ”’ Ejecutando escaneo de seguridad..."
                            
                            sh '''
                                echo "ðŸ” Buscando credenciales hardcodeadas..."
                                if grep -r -i "password\|secret\|key" --include="*.go" . | grep -v "// "; then
                                    echo "âš ï¸ Posibles credenciales encontradas (revisar manualmente)"
                                else
                                    echo "âœ… No se encontraron credenciales obvias"
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ðŸ›‘ Stop Services') {
            steps {
                script {
                    echo "ðŸ›‘ Parando servicios usando manage_services.sh..."
                    
                    def stopResult = sh(
                        script: '''
                            if [ -f "${MANAGE_SERVICES_SCRIPT}" ]; then
                                echo "ðŸ”„ Ejecutando script de gestiÃ³n de servicios..."
                                ${MANAGE_SERVICES_SCRIPT} stop
                            else
                                echo "âš ï¸ Script manage_services.sh no encontrado, usando mÃ©todo manual..."
                                ssh root@178.16.130.178 "systemctl stop herobudget || true"
                            fi
                        ''',
                        returnStatus: true
                    )
                    
                    if (stopResult == 0) {
                        echo "âœ… Servicios parados correctamente"
                    } else {
                        echo "âš ï¸ Advertencia: Problemas parando servicios, continuando..."
                    }
                }
            }
        }
        
        stage('ðŸš€ Webhook Deploy') {
            steps {
                script {
                    echo "ðŸš€ Ejecutando deployment automÃ¡tico con webhook_deploy.sh..."
                    
                    def deployResult = sh(
                        script: '''
                            if [ -f "${WEBHOOK_DEPLOY_SCRIPT}" ]; then
                                echo "ðŸ“¥ Ejecutando script de webhook deployment..."
                                ${WEBHOOK_DEPLOY_SCRIPT} main --force
                            else
                                echo "âŒ Script webhook_deploy.sh no encontrado"
                                exit 1
                            fi
                        ''',
                        returnStatus: true
                    )
                    
                    if (deployResult == 0) {
                        echo "âœ… Deployment automÃ¡tico completado"
                    } else {
                        error "âŒ Error durante deployment automÃ¡tico"
                    fi
                }
            }
        }
        
        stage('ðŸš€ Start Services') {
            steps {
                script {
                    echo "ðŸš€ Iniciando servicios usando manage_services.sh..."
                    
                    def startResult = sh(
                        script: '''
                            if [ -f "${MANAGE_SERVICES_SCRIPT}" ]; then
                                echo "ðŸ”„ Ejecutando script de gestiÃ³n de servicios..."
                                ${MANAGE_SERVICES_SCRIPT} restart
                            else
                                echo "âš ï¸ Script manage_services.sh no encontrado, usando mÃ©todo manual..."
                                ssh root@178.16.130.178 "
                                    systemctl start herobudget
                                    systemctl reload nginx
                                "
                            fi
                        ''',
                        returnStatus: true
                    )
                    
                    if (startResult == 0) {
                        echo "âœ… Servicios iniciados correctamente"
                    } else {
                        error "âŒ Error iniciando servicios"
                    fi
                }
            }
        }
        
        stage('ðŸ” Post-Deploy Verification') {
            steps {
                script {
                    echo "ðŸ” Verificando deployment..."
                    
                    def verifyResult = sh(
                        script: '''
                            if [ -f "${VERIFY_DEPLOYMENT_SCRIPT}" ]; then
                                echo "âœ… Ejecutando verificaciÃ³n automÃ¡tica..."
                                ${VERIFY_DEPLOYMENT_SCRIPT}
                            else
                                echo "âš ï¸ Script de verificaciÃ³n no encontrado, usando verificaciÃ³n manual..."
                                ${MANAGE_SERVICES_SCRIPT} health || echo "Health check manual"
                            fi
                        ''',
                        returnStatus: true
                    )
                    
                    if (verifyResult == 0) {
                        echo "âœ… VerificaciÃ³n exitosa"
                        env.DEPLOYMENT_STATUS = 'SUCCESS'
                    } else {
                        echo "âŒ Fallo en verificaciÃ³n"
                        env.DEPLOYMENT_STATUS = 'FAILED'
                        error "Deployment verification failed"
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "ðŸŽ‰ Â¡DEPLOYMENT EXITOSO!"
                echo "=================================================="
                echo "âœ… Build: ${env.BUILD_NUMBER}"
                echo "âœ… Branch: ${env.GIT_BRANCH}"
                echo "âœ… Timestamp: ${BUILD_TIMESTAMP}"
                echo "âœ… Estado: SUCCESS"
                echo "=================================================="
                
                // Log de Ã©xito
                sh '''
                    echo "âœ… $(date): Deployment exitoso - Build ${BUILD_NUMBER}" >> /opt/hero_budget/logs/jenkins_deployments.log
                '''
            }
        }
        
        failure {
            script {
                echo "âŒ DEPLOYMENT FALLIDO"
                echo "=================================================="
                echo "âŒ Build: ${env.BUILD_NUMBER}"
                echo "âŒ Branch: ${env.GIT_BRANCH}"
                echo "âŒ Timestamp: ${BUILD_TIMESTAMP}"
                echo "âŒ Estado: FAILED"
                echo "=================================================="
                
                // Intentar rollback automÃ¡tico si hay backup
                sh '''
                    echo "ðŸ”„ Intentando rollback automÃ¡tico..."
                    if [ -f "/tmp/last_backup.txt" ]; then
                        BACKUP_FILE=$(cat /tmp/last_backup.txt)
                        if [ -f "/opt/hero_budget/backups/$BACKUP_FILE" ]; then
                            echo "ðŸ“¦ Restaurando backup: $BACKUP_FILE"
                            ssh root@178.16.130.178 "
                                cd /opt/hero_budget
                                systemctl stop herobudget || true
                                rm -rf backend_failed
                                mv backend backend_failed || true
                                tar -xzf backups/$BACKUP_FILE
                                systemctl start herobudget
                            "
                            echo "âœ… Rollback completado"
                        else
                            echo "âŒ Backup no encontrado para rollback"
                        fi
                    else
                        echo "âŒ No hay informaciÃ³n de backup para rollback"
                    fi
                    
                    echo "âŒ $(date): Deployment fallido - Build ${BUILD_NUMBER}" >> /opt/hero_budget/logs/jenkins_deployments.log
                '''
            }
        }
        
        always {
            script {
                echo "ðŸ§¹ Limpieza post-deployment..."
                sh '''
                    # Limpiar archivos temporales
                    rm -f /tmp/last_backup.txt /tmp/last_successful_deploy.txt 2>/dev/null || true
                    
                    # Mostrar estado final de servicios
                    if [ -f "${MANAGE_SERVICES_SCRIPT}" ]; then
                        echo "ðŸ“Š Estado final de servicios:"
                        ${MANAGE_SERVICES_SCRIPT} status || true
                    fi
                '''
            }
        }
    }
} 